{% extends "brs_layout.html" %}
{% block content %}

{% if current_user.user_type in ["admin", "ro_user"] %}

<form class="mb-5" method="post">
    {{ form.csrf_token }}
    <table class="table">
        <tr>
            <th class="is-vcentered">{{ form.month.label }}</th>
            <td>
                <div class="select">{{ form.month }}</div>
            </td>
            <td><button class="button is-success is-outlined">Refresh</button></td>
        </tr>
    </table>
</form>

{% macro render_group(total, completed) %}
{% set pending = total - completed %}
{% if pending == 0 %}
<td class="is-success has-text-right">{{ total }}</td>
<td class="is-success has-text-right">{{ completed }}</td>
<td class="is-success has-text-right">{{ pending }}</td>
{% else %}
<td class="has-text-right">{{ total }}</td>
<td class="has-text-right">{{ completed }}</td>
<td class="has-text-right">{{ pending }}</td>
{% endif %}
{% endmacro %}

<table class="table is-bordered is-hoverable" id="brs_table">
    <thead>
        <tr>
            <th rowspan="2" class="has-text-centered is-vcentered">Regional office</th>
            <th rowspan="2" class="has-text-centered is-vcentered">Month</th>
            <th rowspan="2" class="has-text-centered is-vcentered"></th>
            <th colspan="3" class="has-text-centered">Cash</th>
            <th colspan="3" class="has-text-centered">Cheque</th>
            <th colspan="3" class="has-text-centered">PG</th>
            <th colspan="3" class="has-text-centered">POS</th>
            <th colspan="3" class="has-text-centered">BBPS</th>
            <th colspan="3" class="has-text-centered">Local collection</th>
        </tr>
        <tr class="has-text-centered">
            {% for i in range(6) %}
            <th>Total</th>
            <th>Completed</th>
            <th>Pending</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for entry in query %}
        {% set all_pending =
        (entry[2]-entry[3])+(entry[4]-entry[5])+(entry[6]-entry[7])+(entry[8]-entry[9])+(entry[10]-entry[11])+(entry[12]-entry[13])
        %}
        <tr>
            {% if all_pending == 0 %}
            <td class="is-success">{{ entry[0] }}</td>
            <td class="is-success" data-sort="{{ entry.month|datetime_format('%B-%Y') }}">{{ entry[1] }}</td>
            <td><a class="button is-success is-small"
                    href="{{ url_for('brs.brs_ro_wise', ro_code=entry[0], month=entry[1]) }}">View</a></td>
            {% else %}
            <td>{{ entry[0] }}</td>
            <td data-sort="{{ entry.month|datetime_format('%B-%Y') }}">{{ entry[1] }}</td>
            <td><a class="button is-link is-outlined is-small"
                    href="{{ url_for('brs.brs_ro_wise', ro_code=entry[0], month=entry[1]) }}">View</a></td>
            {% endif %}

            {{ render_group(entry[2], entry[3]) }}
            {{ render_group(entry[4], entry[5]) }}
            {{ render_group(entry[6], entry[7]) }}
            {{ render_group(entry[8], entry[9]) }}
            {{ render_group(entry[10], entry[11]) }}
            {{ render_group(entry[12], entry[13]) }}
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{% block scripts %}
<script>
    new DataTable('#brs_table', {
        layout: { top1Start: 'pageLength', topStart: 'buttons' },
        fixedHeader: true,
        pageLength: 36,
        scrollY: true,
        scrollX: true,
        buttons: [
            { extend: 'copyHtml5', className: 'has-background-danger-light is-rounded', title: '' },
            { extend: 'csvHtml5', className: 'has-background-info-light is-rounded', title: '' },
            { extend: 'excelHtml5', className: 'has-background-primary-light is-rounded', title: '' }
        ],
        order: [[1, 'desc'], [0, 'asc']],
        pagingType: 'full_numbers',
        lengthMenu: [[36, 72, 108, 144, -1], [36, 72, 108, 144, 'All']]
    });
</script>
{% endblock scripts %}

{% endblock content %}

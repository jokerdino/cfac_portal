{% extends "pool_credits_layout.html" %}

{% block content %}

<div class="container is-fluid mt-5 pb-5">
    <h1 class="title is-size-4">HDFC Pool account - List of {{ status | replace("jv_", "JV ") }} entries</h1>
    {% include "partials/messages.html" %}
    {% include "partials/errors.html" %}
    <form method="post">
        {% if status == "confirmed" and current_user.user_type == "admin" %}
        <div class="has-text-right">
            <button class="button is-success is-outlined">Mark selected entries as JV passed</button>
        </div>
        {% endif %}
        <table class="table is-bordered is-striped is-hoverable is-fullwidth" id="pool_credits_table">
            <thead>
                <tr>
                    {% if status == "confirmed" and current_user.user_type == "admin" %}
                    <th class="has-text-centered is-vcentered"><input type="checkbox" onclick="select_all()"
                            id="select_all_button" /></th>
                    {% endif %}
                    <th class="has-text-centered is-vcentered">Book date</th>
                    <th class="has-text-centered is-vcentered">Description</th>
                    <th class="has-text-centered is-vcentered">Credit</th>

                    <th class="has-text-centered is-vcentered">Value date</th>
                    <th class="has-text-centered is-vcentered">Reference number</th>
                    <th class="has-text-centered is-vcentered">Confirmed by</th>
                    {% if status != "jv_passed" %}
                    <th class="has-text-centered is-vcentered">Edit</th>
                    {% endif %}
                </tr>
            </thead>

        </table>
    </form>
</div>
<div id="datatable-config" data-ajax-url="{{ url_for('pool_credits.get_data', status=status) }}"
    data-show-checkbox="{{ 'true' if status == 'confirmed' and current_user.user_type == 'admin' else 'false' }}"
    data-edit-url="{{ url_for('pool_credits.update_pool_credit', id=0) }}">
</div>
<div class="modal" id="edit-modal">
    <div class="modal-background" onclick="closeModal()"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Edit Pool Credit</p>
            <button class="delete" onclick="closeModal()"></button>
        </header>
        <section class="modal-card-body" id="modal-content">
            <!-- AJAX content -->
        </section>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const tableEl = document.getElementById("pool_credits_table");

        // Prevent reinitialization
        if ($.fn.dataTable.isDataTable(tableEl)) {
            return;
        }

        const configEl = document.getElementById("datatable-config");
        const ajaxUrl = configEl.dataset.ajaxUrl;
        const showCheckbox = configEl.dataset.showCheckbox === "true";

        // Create a URL pattern with a placeholder
        const editUrlTemplate = configEl.dataset.editUrl; // e.g. "/pool_credits/edit/0/"

        const columns = [];

        if (showCheckbox) {
            columns.push({
                data: "id",
                className: "dt-body-center",
                sortable: false,
                render: (data) => `<input type="checkbox" name="pool_keys" value="${data}">`,
            });
        }

        columns.push(
            { data: "book_date", className: "dt-body-center" },
            { data: "description" },
            { data: "credit", className: "dt-body-right" },
            { data: "value_date", className: "dt-body-center" },
            { data: "reference_no" },
            { data: "str_regional_office_code" },);

        // ONLY ADD THE EDIT COLUMN IF NOT JV_PASSED
        if ("{{ status }}" !== "jv_passed") {
            columns.push({
                data: "id",
                orderable: false, // Usually don't want to sort by the button column
                render: (id) =>
                    `<button type="button" class="button is-small is-link is-outlined"
            onclick="openEditModal(${id})">
            Edit
        </button>`,
            });
        }

        new DataTable(tableEl, {
            ajax: ajaxUrl,
            serverSide: true,
            processing: true,
            layout: {
                topStart: "pageLength",
                top2Start: {
                    buttons: [
                        { extend: "copyHtml5", className: "has-background-danger-light is-rounded", title: "" },
                        { extend: "csvHtml5", className: "has-background-info-light is-rounded", title: "" },
                        { extend: "excelHtml5", className: "has-background-primary-light is-rounded", title: "" },
                    ],
                },
            },
            columns,
            order: [[showCheckbox ? 7 : 6, "desc"]],
        });
    });
</script>
<script>
    function select_all() {
        const masterCheckbox = document.getElementById('select_all_button');
        const checkboxes = document.querySelectorAll('input[name="pool_keys"]');

        checkboxes.forEach(cb => {
            cb.checked = masterCheckbox.checked;
        });
    }
</script>

<script>
    const editUrlTemplate = document.getElementById("datatable-config").dataset.editUrl;
    function openEditModal(id) {

        const url = editUrlTemplate.replace('0', id);
        fetch(url, {
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
            .then(r => r.text())
            .then(html => {
                document.getElementById("modal-content").innerHTML = html;
                document.getElementById("edit-modal").classList.add("is-active");

                const form = document.getElementById("edit-pool-credit-form");
                form.addEventListener("submit", function (e) {
                    e.preventDefault();
                    submitEditForm(form, id);
                });
            });
    }

    function submitEditForm(form, id) {
        const url = editUrlTemplate.replace('0', id);
        fetch(url, {
            method: "POST",
            body: new FormData(form),
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    $('#pool_credits_table').DataTable().ajax.reload(null, false);
                }
            });
    }

    function closeModal() {
        document.getElementById("edit-modal").classList.remove("is-active");
    }
</script>

{% endblock scripts %}

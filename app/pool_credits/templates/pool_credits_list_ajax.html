{% extends "pool_credits_layout.html" %}

{% block content %}

<div class="container is-fluid mt-5 pb-5">
    <h1 class="title is-size-4">HDFC Pool account - List of {{ status | replace("jv_", "JV ") }} entries</h1>
    {% include "partials/messages.html" %}
    {% include "partials/errors.html" %}
    <form method="post">
        {% if status == "confirmed" and current_user.user_type == "admin" %}
        <div class="has-text-right">
            <button class="button is-success is-outlined">Mark selected entries as JV passed</button>
        </div>
        {% endif %}
        <table class="table is-bordered is-striped is-hoverable is-fullwidth" id="pool_credits_table">
            <thead>
                <tr>
                    {% if status == "confirmed" and current_user.user_type == "admin" %}
                    <th class="has-text-centered is-vcentered"><input type="checkbox" onclick="select_all()"
                            id="select_all_button" /></th>
                    {% endif %}
                    <th class="has-text-centered is-vcentered">Book date</th>
                    <th class="has-text-centered is-vcentered">Description</th>
                    <th class="has-text-centered is-vcentered">Credit</th>

                    <th class="has-text-centered is-vcentered">Value date</th>
                    <th class="has-text-centered is-vcentered">Reference number</th>
                    <th class="has-text-centered is-vcentered">Confirmed by</th>
                    <th class="has-text-centered is-vcentered">Edit</th>
                </tr>
            </thead>

        </table>
    </form>
</div>
<div id="datatable-config" data-ajax-url="{{ url_for('pool_credits.get_data', status=status) }}"
    data-show-checkbox="{{ 'true' if status == 'confirmed' and current_user.user_type == 'admin' else 'false' }}"
    data-edit-url="{{ url_for('pool_credits.update_pool_credit', id=0) }}">
</div>

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const tableEl = document.getElementById("pool_credits_table");

        // Prevent reinitialization
        if ($.fn.dataTable.isDataTable(tableEl)) {
            return;
        }

        const configEl = document.getElementById("datatable-config");
        const ajaxUrl = configEl.dataset.ajaxUrl;
        const showCheckbox = configEl.dataset.showCheckbox === "true";

        // Create a URL pattern with a placeholder
        const editUrlTemplate = configEl.dataset.editUrl; // e.g. "/pool_credits/edit/0/"

        const columns = [];

        if (showCheckbox) {
            columns.push({
                data: "id",
                className: "dt-body-center",
                sortable: false,
                render: (data) => `<input type="checkbox" name="pool_keys" value="${data}">`,
            });
        }

        columns.push(
            { data: "book_date", className: "dt-body-center" },
            { data: "description" },
            { data: "credit", className: "dt-body-right" },
            { data: "value_date", className: "dt-body-center" },
            { data: "reference_no" },
            { data: "str_regional_office_code" },
            {
                data: "id",
                render: (data) =>
                    `<a class="button is-small is-link is-outlined" href="${editUrlTemplate.replace('0', data)}">Edit</a>`,
            },
        );

        new DataTable(tableEl, {
            ajax: ajaxUrl,
            serverSide: true,
            processing: true,
            layout: {
                topStart: "pageLength",
                top2Start: {
                    buttons: [
                        { extend: "copyHtml5", className: "has-background-danger-light is-rounded", title: "" },
                        { extend: "csvHtml5", className: "has-background-info-light is-rounded", title: "" },
                        { extend: "excelHtml5", className: "has-background-primary-light is-rounded", title: "" },
                    ],
                },
            },
            columns,
            order: [[showCheckbox ? 7 : 6, "desc"]],
        });
    });
</script>
<script>
    function select_all() {

        var checkbox = document.getElementsByName('pool_keys');

        for (var i = 0; i < checkbox.length; i++) {
            if (checkbox[i].type == 'checkbox')

                checkbox[i].checked = document.getElementById('select_all_button').checked;
        }
    }

</script>
{% endblock scripts %}

{% endblock content %}
